<!DOCTYPE html>
<html lang="tr" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>PNP Kontrol Merkezi</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <!-- HEADER -->
    <header class="header">
        <div class="h-brand">
            <div class="h-logo">P</div>
            <div>
                <div class="h-title">PNP Kontrol Merkezi</div>
                <div class="h-sub">Pick & Place CNC v2.0</div>
            </div>
        </div>
        <div class="h-center">
            <button class="tab-btn active" data-tab="control" onclick="switchTab('control')">üéÆ Kontrol</button>
            <button class="tab-btn" data-tab="ocr" onclick="switchTab('ocr')">üîç OCR</button>
            <button class="tab-btn" data-tab="calibration" onclick="switchTab('calibration')">üîß Kalibrasyon</button>
            <button class="tab-btn" data-tab="settings" onclick="switchTab('settings')">‚öôÔ∏è Ayarlar</button>
        </div>
        <div class="h-right">
            <div class="badge ok" id="motorBadge"><span class="dot"></span><span id="motorBadgeTxt">Motor</span></div>
            <div class="grbl-badge idle" id="grblBadge">IDLE</div>
            <span class="uptime" id="uptimeEl">‚è± 00:00:00</span>
            <button class="theme-btn" onclick="toggleTheme()" title="Tema">üåì</button>
            <a href="/logout" class="logout-btn">√áƒ±kƒ±≈ü</a>
        </div>
    </header>
    <!-- ALARM BAR -->
    <div class="alarm-bar" id="alarmBar">‚ö†Ô∏è ALARM ‚Äî Makine kilitli!
        <button onclick="unlockGrbl()">üîì Unlock ($X)</button><button onclick="softReset()">üîÑ Reset</button>
    </div>
    <!-- TOAST CONTAINER -->
    <div class="toast-container" id="toastBox"></div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: KONTROL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <main class="tab-content active" id="tab-control">
        <div class="ctrl-layout">
            <!-- LEFT: CONSOLE -->
            <div class="ctrl-console-col">
                <!-- Console (Shrunk) -->
                <div class="card console-card"
                    style="width:100%; height:40%; display:flex; flex-direction:column; margin-bottom:10px">
                    <div class="card-h"><span class="card-t">üìã Konsol</span>
                        <button class="btn-sm" onclick="clearConsole()">Temizle</button>
                    </div>
                    <div class="card-b console-body" style="flex:1; min-height:0; overflow:hidden">
                        <div class="console-box" id="console" style="flex:1; overflow-y:auto; min-height:0">
                            <div class="cline info"><span class="ct">[--:--:--]</span> Baƒülanƒ±yor...</div>
                        </div>
                        <div class="gcode-row"><input class="gcode-in" id="gcodeIn" placeholder="G-code komutu..."
                                onkeydown="if(event.key==='Enter')sendGcode()"><button class="gcode-btn"
                                onclick="sendGcode()">‚ñ∂</button></div>
                    </div>
                </div>

                <!-- Auto-Center Control Panel (New) -->
                <div class="card" style="width:100%; flex:1; display:flex; flex-direction:column;">
                    <div class="card-h"><span class="card-t">üéØ Oto-Merkezleme</span></div>
                    <div class="card-b" style="display:flex; flex-direction:column; gap:8px; padding:10px; flex:1">

                        <!-- Target Input -->
                        <div class="grp-label" style="font-size:0.75rem; color:#aaa">HEDEF KELƒ∞ME</div>
                        <div style="display:flex; gap:6px; flex-direction:column">
                            <input type="text" id="targetInput" list="ocrWordsList" class="cam-inp"
                                placeholder="Kelime girin..." style="width:100%; text-transform:uppercase">
                            <datalist id="ocrWordsList"></datalist>

                            <!-- Big Center Button -->
                            <button id="acBtn" class="btn btn-p ripple"
                                style="padding:12px; font-size:1rem; font-weight:bold" onclick="startAutoCenter()">
                                MERKEZLE
                            </button>
                        </div>

                        <!-- Status Display -->
                        <div id="acStatusBox"
                            style="background:rgba(0,0,0,0.3); border-radius:4px; padding:8px; margin-top:auto; height: 100px; overflow-y:auto; font-family:'JetBrains Mono'; font-size:0.75rem">
                            <div style="color:#666">Hazƒ±r.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CENTER: CAMERA -->
            <div class="ctrl-left">
                <div class="cam-wrap" id="camWrap">
                    <img id="camFeed" src="/video_feed" alt="Kamera">
                    <!-- Overlays -->
                    <!-- TOP LEFT: Stats -->
                    <div class="cam-stats" id="camStats">
                        <div class="stat-item">CAM: <span id="fpsCam">--</span></div>
                        <div class="stat-item">OCR: <span id="fpsOcr">--</span></div>
                    </div>

                    <!-- TOP RIGHT: Live Status -->
                    <div class="cam-live-badge">LIVE</div>

                    <!-- BOTTOM RIGHT: Settings & Resolution -->
                    <div class="cam-bottom-right">
                        <button class="cam-set-btn ripple" onclick="toggleCamSettings()"
                            title="√á√∂z√ºn√ºrl√ºk Ayarlarƒ±">‚öôÔ∏è</button>
                        <div class="cam-res-badge" id="camResBadge">--√ó--</div>
                    </div>

                    <!-- Quick Zoom REMOVED as requested -->
                    <div class="cam-controls" style="pointer-events:none">
                        <!-- Empty container to keep layout if needed, or remove completely -->
                    </div>

                    <!-- Settings Overlay -->
                    <div class="cam-settings" id="camSettings">
                        <div class="cam-set-h">Kamera & Yayƒ±n Ayarlarƒ±</div>

                        <!-- Presets -->
                        <div class="cam-presets">
                            <button class="btn-sm" onclick="setRes(640,480)">640x480</button>
                            <button class="btn-sm" onclick="setRes(800,600)">800x600</button>
                            <button class="btn-sm" onclick="setRes(1280,720)">720p</button>
                            <button class="btn-sm" onclick="setRes(800,1080)">800x1080</button>
                            <button class="btn-sm" onclick="setRes(1920,1080)">1080p</button>
                        </div>

                        <div class="sep" style="margin:8px 0"></div>

                        <!-- Capture Resolution -->
                        <div style="font-size:0.7rem; color:#aaa; margin-bottom:4px">YAKALAMA (OCR)</div>
                        <div class="cam-set-row">
                            <input type="number" class="cam-inp" id="camW" value="800" placeholder="W">
                            <span class="cam-x">√ó</span>
                            <input type="number" class="cam-inp" id="camH" value="1080" placeholder="H">
                        </div>

                        <!-- Stream Resolution -->
                        <div style="font-size:0.7rem; color:#aaa; margin:8px 0 4px 0">YAYIN (EKRAN)</div>
                        <!-- Stream Presets -->
                        <div class="cam-presets" style="margin-bottom:6px">
                            <button class="btn-sm" onclick="setStreamRes(300, this)">D√º≈ü√ºk</button>
                            <button class="btn-sm" onclick="setStreamRes(500, this)">Orta</button>
                            <button class="btn-sm" onclick="setStreamRes(800, this)">Y√ºksek</button>
                        </div>
                        <div class="cam-set-row">
                            <input type="number" class="cam-inp" id="streamW" value="800" placeholder="Geni≈ülik (px)">
                            <span style="font-size:0.7rem; color:#666; margin-left:4px">px</span>
                        </div>

                        <button class="btn btn-p ripple"
                            style="padding:6px 12px;font-size:0.75rem;width:100%;margin-top:12px"
                            onclick="applyCamRes()">Uygula & Yeniden Ba≈ülat</button>
                    </div>
                </div>
                <div id="camOverlayText" class="cam-overlay-text"></div>
            </div>
            <div class="ctrl-right">
                <!-- KOORDƒ∞NATLAR -->
                <div class="card coord-card">
                    <div class="card-h"><span class="card-t">üìç Pozisyon</span><span class="grbl-sm"
                            id="grblSm">IDLE</span>
                    </div>
                    <div class="coord-grid">
                        <div class="coord"><span class="cl">X</span><span class="cv" id="posX">0.00</span><span
                                class="cu">mm</span></div>
                        <div class="coord"><span class="cl">Y</span><span class="cv" id="posY">0.00</span><span
                                class="cu">mm</span></div>
                        <div class="coord"><span class="cl">Z</span><span class="cv" id="posZ">0.00</span><span
                                class="cu">mm</span></div>
                    </div>
                </div>
                <!-- AKSƒ∞YONLAR -->
                <div class="card">
                    <div class="card-h"><span class="card-t">‚ö° Aksiyonlar</span></div>
                    <div class="card-b">
                        <div class="act-col">
                            <div class="ac-st" id="acSt">
                                <div class="spinner"></div><span id="acMsg"></span>
                            </div>
                            <div class="btn-row"><button class="btn btn-g ripple" onclick="pumpCtl(true)">üí® Pompa
                                    A√á</button><button class="btn btn-d ripple" onclick="pumpCtl(false)">üõë
                                    KAPAT</button></div>
                            <div class="btn-row"><button class="btn btn-y ripple" onclick="unlockGrbl()">üîì
                                    Unlock</button><button class="btn btn-c ripple" onclick="softReset()">üîÑ
                                    Reset</button></div>
                            <button class="btn btn-w ripple" onclick="emergencyStop()">üö® ACƒ∞L DURDUR</button>
                        </div>
                    </div>
                </div>
                <!-- MOTOR -->
                <div class="card">
                    <div class="card-h"><span class="card-t">üéÆ Motor Kontrol√º</span></div>
                    <div class="card-b" style="text-align:center">
                        <div class="motor-area">
                            <!-- XY Grid: 3x3 with diagonals -->
                            <div class="xy-grid">
                                <button class="mbtn ripple" onclick="moveMotor(-1,-1)" title="Sol Yukarƒ±">‚Üñ</button>
                                <button class="mbtn ripple" onclick="moveMotor(0,-1)" title="Yukarƒ±">‚ñ≤</button>
                                <button class="mbtn ripple" onclick="moveMotor(1,-1)" title="Saƒü Yukarƒ±">‚Üó</button>
                                <button class="mbtn ripple" onclick="moveMotor(-1,0)" title="Sol">‚óÄ</button>
                                <button class="mbtn mhome ripple" onclick="homeMotor()">HOME</button>
                                <button class="mbtn ripple" onclick="moveMotor(1,0)" title="Saƒü">‚ñ∂</button>
                                <button class="mbtn ripple" onclick="moveMotor(-1,1)" title="Sol A≈üaƒüƒ±">‚Üô</button>
                                <button class="mbtn ripple" onclick="moveMotor(0,1)" title="A≈üaƒüƒ±">‚ñº</button>
                                <button class="mbtn ripple" onclick="moveMotor(1,1)" title="Saƒü A≈üaƒüƒ±">‚Üò</button>
                            </div>
                            <!-- Z Axis -->
                            <div class="z-col">
                                <span class="z-label">Z</span>
                                <button class="mbtn zbtn ripple" onclick="moveZ(1)" title="Z Yukarƒ±">‚ñ≤</button>
                                <button class="mbtn zbtn ripple" onclick="moveZ(-1)" title="Z A≈üaƒüƒ±">‚ñº</button>
                            </div>
                        </div>
                        <div class="step-row"><span class="sl">Adƒ±m:</span>
                            <div class="step-btns">
                                <button class="sb" onclick="setStep(0.1)">0.1</button><button class="sb"
                                    onclick="setStep(0.5)">0.5</button>
                                <button class="sb active" onclick="setStep(1)">1.0</button><button class="sb"
                                    onclick="setStep(5)">5.0</button><button class="sb"
                                    onclick="setStep(10)">10</button>
                            </div><span class="sl">mm</span>
                        </div>
                    </div>
                </div>
                <!-- KONSOL -->
                <!-- KONSOL REMOVED -->
            </div>
        </div>
    </main>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: OCR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <main class="tab-content" id="tab-ocr">
        <div class="ocr-layout">
            <div class="ocr-left">
                <div class="card">
                    <div class="card-h"><span class="card-t">üîç OCR Algƒ±lama</span><span class="badge-count"
                            id="ocrCnt2">0</span></div>
                    <div class="card-b">
                        <div class="info-row"><span>Kamera FPS</span><span class="mono" id="camFps">--</span></div>
                        <div class="info-row"><span>OCR FPS</span><span class="mono" id="ocrFps">--</span></div>
                        <div class="info-row"><span>Algƒ±lanan</span><span class="mono" id="detCnt">0</span></div>
                        <div class="info-row"><span>Hedef Durum</span><span id="tgtSt"
                                class="mono tgt-search">Aranƒ±yor</span></div>
                        <div class="sep"></div>
                        <div class="ocr-results" id="ocrList">
                            <div class="ocr-empty">Yazƒ± algƒ±lanmadƒ±</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="ocr-right">
                <!-- HEDEF KELƒ∞MELER -->
                <div class="card">
                    <div class="card-h"><span class="card-t">üéØ Hedef Kelimeler</span></div>
                    <div class="card-b">
                        <p class="card-desc">OCR tarafƒ±ndan aranacak kelimeler. Bulunan kelime ye≈üil olarak i≈üaretlenir.
                        </p>
                        <!-- Dynamic Word List Container -->
                        <div id="wordList"></div>
                    </div>
                </div>
                <!-- HATA LOG -->
                <div class="card">
                    <div class="card-h"><span class="card-t">‚ö†Ô∏è Hata Ge√ßmi≈üi</span>
                        <button class="btn-sm" onclick="clearErrors()">Temizle</button>
                    </div>
                    <div class="card-b error-list" id="errorList">
                        <div class="ocr-empty">Hata yok</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: KALƒ∞BRASYON ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <main class="tab-content" id="tab-calibration">
        <div class="cw-grid">
            <!-- SOL KOLON: Kamera -->
            <div class="cw-col">
                <div class="card">
                    <div class="card-h"><span class="card-t">üì∑ Canlƒ± Kamera</span><span class="badge-count">Y√∂n
                            Testi</span></div>
                    <div class="card-b cw-cam-box">
                        <img class="cw-cam" src="/video_feed" alt="Kamera">
                        <div class="cw-crosshair">
                            <div class="cw-ch cw-ch-h"></div>
                            <div class="cw-ch cw-ch-v"></div>
                            <div class="cw-ch-center">‚ú¶</div>
                        </div>
                    </div>
                </div>
                <!-- Mevcut Durum -->
                <div class="card">
                    <div class="card-h"><span class="card-t">üìã Kalibrasyon Durumu</span></div>
                    <div class="card-b">
                        <div class="info-row"><span>Eksen Swap</span><span class="mono" id="calSwap">--</span></div>
                        <div class="info-row"><span>Ekran X Ters</span><span class="mono" id="calNegX">--</span></div>
                        <div class="info-row"><span>Ekran Y Ters</span><span class="mono" id="calNegY">--</span></div>
                        <div class="sep"></div>
                        <div class="cw-summary" id="calMapText">Hen√ºz kalibre edilmedi.</div>
                    </div>
                </div>
            </div>
            <!-- SAƒû KOLON: Wizard -->
            <div class="cw-col">
                <!-- Adƒ±m 1 -->
                <div class="card cw-step-card">
                    <div class="card-h"><span class="card-t"><span class="cw-num">1</span> Motor X+ Testi</span></div>
                    <div class="card-b">
                        <p class="card-desc">Butona basƒ±n, motor X+ y√∂n√ºne hareket edecek. Kamerada nesne hangi y√∂ne
                            gitti?</p>
                        <button class="btn btn-p ripple" onclick="calTestMotor('x',1)" style="margin-bottom:10px">‚ñ∂
                            Motor X+ Hareket Ettir</button>
                        <div class="cw-pick" id="calPickX">
                            <button class="cw-dir ripple" onclick="calSetMapping('x','up')"><span
                                    class="cw-dir-icon">‚¨Ü</span>Yukarƒ±</button>
                            <button class="cw-dir ripple" onclick="calSetMapping('x','right')"><span
                                    class="cw-dir-icon">‚û°</span>Saƒü</button>
                            <button class="cw-dir ripple" onclick="calSetMapping('x','down')"><span
                                    class="cw-dir-icon">‚¨á</span>A≈üaƒüƒ±</button>
                            <button class="cw-dir ripple" onclick="calSetMapping('x','left')"><span
                                    class="cw-dir-icon">‚¨Ö</span>Sol</button>
                        </div>
                    </div>
                </div>
                <!-- Adƒ±m 2 -->
                <div class="card cw-step-card">
                    <div class="card-h"><span class="card-t"><span class="cw-num">2</span> Motor Y+ Testi</span></div>
                    <div class="card-b">
                        <p class="card-desc">Butona basƒ±n, motor Y+ y√∂n√ºne hareket edecek. Kamerada nesne hangi y√∂ne
                            gitti?</p>
                        <button class="btn btn-p ripple" onclick="calTestMotor('y',1)" style="margin-bottom:10px">‚ñ∂
                            Motor Y+ Hareket Ettir</button>
                        <div class="cw-pick" id="calPickY">
                            <button class="cw-dir ripple" onclick="calSetMapping('y','up')"><span
                                    class="cw-dir-icon">‚¨Ü</span>Yukarƒ±</button>
                            <button class="cw-dir ripple" onclick="calSetMapping('y','right')"><span
                                    class="cw-dir-icon">‚û°</span>Saƒü</button>
                            <button class="cw-dir ripple" onclick="calSetMapping('y','down')"><span
                                    class="cw-dir-icon">‚¨á</span>A≈üaƒüƒ±</button>
                            <button class="cw-dir ripple" onclick="calSetMapping('y','left')"><span
                                    class="cw-dir-icon">‚¨Ö</span>Sol</button>
                        </div>
                    </div>
                </div>
                <!-- Manuel Ayar -->
                <div class="card">
                    <div class="card-h"><span class="card-t">‚öôÔ∏è Manuel Eksen Ayarƒ±</span>
                        <button class="btn btn-p ripple" style="padding:5px 14px;font-size:12px;width:auto"
                            onclick="saveCalibration()">üíæ Kaydet</button>
                    </div>
                    <div class="card-b">
                        <div class="cfg-r"><label>Eksenleri Deƒüi≈ütir (Swap X‚ÜîY)</label><input type="checkbox"
                                class="cfg-cb" id="calSwapCb" checked></div>
                        <div class="cfg-r"><label>Ekran X Ters √áevir</label><input type="checkbox" class="cfg-cb"
                                id="calNegXCb"></div>
                        <div class="cfg-r"><label>Ekran Y Ters √áevir</label><input type="checkbox" class="cfg-cb"
                                id="calNegYCb" checked></div>
                        <div class="sep"></div>
                        <div class="cfg-r"><label>Test Adƒ±mƒ± (mm)</label><input type="number" class="cfg-in"
                                id="calStep" value="2" step="0.5" min="0.5" max="20"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: AYARLAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <main class="tab-content" id="tab-settings">
        <div class="settings-layout">
            <div class="card">
                <div class="card-h"><span class="card-t">üìê Kalibrasyon</span>
                    <button class="btn btn-p ripple" style="padding:6px 16px;font-size:13px" onclick="saveConfig()">üíæ
                        Kaydet</button>
                </div>
                <div class="card-b">
                    <div class="cfg-grid">
                        <div class="cfg-group">
                            <h3>Piksel ‚Üí mm D√∂n√º≈ü√ºm√º</h3>
                            <div class="cfg-r"><label>X Katsayƒ±sƒ±</label><input type="number" step="0.001"
                                    class="cfg-in" id="cfgPxX" value="0.1"></div>
                            <div class="cfg-r"><label>Y Katsayƒ±sƒ±</label><input type="number" step="0.001"
                                    class="cfg-in" id="cfgPxY" value="0.1"></div>
                        </div>
                        <div class="cfg-group">
                            <h3>Hedef Nokta (Piksel)</h3>
                            <div class="cfg-r"><label>Hedef X</label><input type="number" class="cfg-in" id="cfgTX"
                                    value="200"></div>
                            <div class="cfg-r"><label>Hedef Y</label><input type="number" class="cfg-in" id="cfgTY"
                                    value="150"></div>
                        </div>
                        <div class="cfg-group">
                            <h3>Motor Ayarlarƒ±</h3>
                            <div class="cfg-r"><label>Feed Rate (mm/dk)</label><input type="number" class="cfg-in"
                                    id="cfgFeed" value="1000"></div>
                            <div class="cfg-r"><label>Tolerans (px)</label><input type="number" class="cfg-in"
                                    id="cfgTol" value="5"></div>
                            <div class="cfg-r"><label>Maks ƒ∞terasyon</label><input type="number" class="cfg-in"
                                    id="cfgMaxIter" value="10"></div>
                        </div>
                        <div class="cfg-group">
                            <h3>Y√∂n Ayarlarƒ±</h3>
                            <div class="cfg-r"><label>X Ekseni Ters</label><input type="checkbox" class="cfg-cb"
                                    id="cfgIX"></div>
                            <div class="cfg-r"><label>Y Ekseni Ters</label><input type="checkbox" class="cfg-cb"
                                    id="cfgIY"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-h"><span class="card-t">‚ÑπÔ∏è Sistem Bilgisi</span></div>
                <div class="card-b">
                    <div class="info-row"><span>Motor Port</span><span class="mono" id="sysPort">--</span></div>
                    <div class="info-row"><span>Motor Durum</span><span class="mono" id="sysMotor">--</span></div>
                    <div class="info-row"><span>Kamera</span><span class="mono" id="sysCam">--</span></div>
                    <div class="info-row"><span>GRBL State</span><span class="mono" id="sysGrbl">--</span></div>
                    <div class="info-row"><span>√áalƒ±≈üma S√ºresi</span><span class="mono" id="sysUptime">--</span></div>
                    <div class="sep"></div>
                    <div class="info-row"><span>Klavye Kƒ±sayollarƒ±</span><span></span></div>
                    <div class="shortcut-list">
                        <div>‚¨Ü‚¨á‚¨Ö‚û° Motor Hareket</div>
                        <div>H ‚Äî Home</div>
                        <div>C ‚Äî Auto-Center</div>
                        <div>E ‚Äî Acil Durdur</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="/static/app.js"></script>
</body>

</html>